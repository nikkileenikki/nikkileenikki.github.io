<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live OTT Overlay (Web)</title>

  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />

  <style>
    body { margin: 0; background: #000; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .player-wrap { position: relative; width: 100vw; height: 100vh; }
    #livePlayer { width: 100%; height: 100%; }

    #adOverlay {
      position: absolute; inset: 0;
      display: none;
      align-items: center; justify-content: center;
      background: rgba(0, 0, 0, 0.35);
      z-index: 10;
      pointer-events: none;
    }

    #adBox {
      position: relative;
      width: 100%;
      height: 100%;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      pointer-events: auto;
      box-shadow: 0 20px 50px rgba(0,0,0,.6);
    }

    #adVideo { width: 100%; height: 100%; }

    #adUI {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      justify-content: space-between;
      padding: 12px; color: #fff;
      pointer-events: none;
    }

    #adTop { display: flex; justify-content: space-between; align-items: center; }

    #badge {
      background: rgba(0,0,0,.6);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    #skipBtn {
      pointer-events: auto;
      display: none!important;
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.25);
      color: #fff;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
    }

    #tapHint {
      position: absolute;
      left: 12px; right: 12px; bottom: 12px;
      background: rgba(0,0,0,.6);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      display: none;
      pointer-events: auto;
      cursor: pointer;
      user-select: none;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="player-wrap">
    <video
      id="livePlayer"
      class="video-js vjs-default-skin"
      autoplay
      muted
      controls
      playsinline
    ></video>

    <div id="adOverlay">
      <div id="adBox">
        <video id="adVideo" playsinline></video>

        <div id="adUI">
          <div id="adTop">
            <div id="badge">Ad • <span id="countdown">15</span>s</div>
            <button id="skipBtn">Skip</button>
          </div>
        </div>

        <div id="tapHint">Tap to enable sound</div>
      </div>
    </div>
  </div>

  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <script>
    /*************************************************
     * CONFIG
     *************************************************/
    const HLS_URL =
      "https://devstreaming-cdn.apple.com/videos/streaming/examples/bipbop_16x9/bipbop_16x9_variant.m3u8";

    const SCHEDULE_URL =
      "https://nikkileenikki.github.io/test/schedule.json";

    const WORKER_BASE =
      "https://time-api2.nikki-lee-nikki.workers.dev";

    const TIME_URL = WORKER_BASE + "/time";
    const VAST_PROXY = WORKER_BASE + "/vast?url=";

    /*************************************************
     * AUDIO STATE
     *************************************************/
    // Browsers block autoplay-with-sound until user gesture.
    // We'll treat "soundEnabled" as "user has interacted and wants audio".
    let soundEnabled = false;

    // First user interaction enables sound for ads (and later content)
    function enableSound() {
      soundEnabled = true;
      // Unmute live stream if no ad is playing
      if (!playing) player.muted(false);
    }
    window.addEventListener("pointerdown", enableSound, { once: true });
    window.addEventListener("keydown", enableSound, { once: true });

    /*************************************************
     * PLAYER INIT
     *************************************************/
    const player = videojs("livePlayer", {
      liveui: true,
      html5: { vhs: { overrideNative: true } },
      sources: [{ src: HLS_URL, type: "application/x-mpegURL" }]
    });

    /*************************************************
     * TIME SYNC
     *************************************************/
    async function getServerOffsetMs() {
      try {
        const t0 = performance.now();
        const r = await fetch(TIME_URL, { cache: "no-store", mode: "cors" });
        const j = await r.json();
        const t1 = performance.now();
        return (j.unixMs + (t1 - t0) / 2) - Date.now();
      } catch (e) {
        console.warn("Time sync failed, using device time:", e);
        return 0;
      }
    }

    let serverOffsetMs = 0;
    let schedule = [];
    let playing = false;
    const playedIds = new Set();

    /*************************************************
     * OVERLAY CONTROL
     *************************************************/
    const overlay = document.getElementById("adOverlay");
    const adVideo = document.getElementById("adVideo");
    const countdownEl = document.getElementById("countdown");
    const skipBtn = document.getElementById("skipBtn");
    const tapHint = document.getElementById("tapHint");

    function showOverlay() { overlay.style.display = "flex"; }
    function hideOverlay() { overlay.style.display = "none"; tapHint.style.display = "none"; }

    function fireBeacon(url) {
      if (!url) return;
      const img = new Image();
      img.src = url + (url.includes("?") ? "&" : "?") + "cb=" + Math.random();
    }

    async function fetchVastXml(vastUrl) {
      const proxied = VAST_PROXY + encodeURIComponent(vastUrl);
      const r = await fetch(proxied, { cache: "no-store", mode: "cors" });
      if (!r.ok) throw new Error("VAST fetch failed: " + r.status);
      return await r.text();
    }

    function pickFirstMediaFile(doc) {
      const mediaFiles = Array.from(doc.getElementsByTagName("MediaFile"));
      const mp4 = mediaFiles.find(n => ((n.getAttribute("type") || "").toLowerCase().includes("mp4"))) || mediaFiles[0];
      return mp4 ? (mp4.textContent || "").trim() : null;
    }

    function getImpressions(doc) {
      return Array.from(doc.getElementsByTagName("Impression"))
        .map(n => (n.textContent || "").trim())
        .filter(Boolean);
    }

    function getTracking(doc) {
      const out = {};
      const nodes = Array.from(doc.getElementsByTagName("Tracking"));
      for (const n of nodes) {
        const ev = n.getAttribute("event");
        const u = (n.textContent || "").trim();
        if (!ev || !u) continue;
        (out[ev] ||= []).push(u);
      }
      return out;
    }

    async function resolveVast(vastUrl, maxWrappers = 3) {
      let current = vastUrl;

      for (let i = 0; i <= maxWrappers; i++) {
        const xml = await fetchVastXml(current);
        const doc = new DOMParser().parseFromString(xml, "text/xml");

        const mediaUrl = pickFirstMediaFile(doc);
        const impressions = getImpressions(doc);
        const tracking = getTracking(doc);

        if (mediaUrl) return { mediaUrl, impressions, tracking };

        const next = doc.getElementsByTagName("VASTAdTagURI")[0];
        const nextUrl = next ? (next.textContent || "").trim() : null;
        if (!nextUrl) throw new Error("No MediaFile and no Wrapper VASTAdTagURI");
        current = nextUrl;
      }

      throw new Error("Too many VAST wrappers");
    }

    async function playOverlayAd(item) {
      if (playing || playedIds.has(item.id)) return;

      if (!item.vastUrl) {
        console.warn("Missing vastUrl in schedule item:", item);
        return;
      }

      playing = true;
      playedIds.add(item.id);

      showOverlay();

      // ✅ MUTE LIVE STREAM DURING AD
      player.muted(true);

      const total = Math.max(5, Number(item.durationSec) || 30);
      let remaining = total;
      countdownEl.textContent = remaining;
      skipBtn.style.display = "none";

      let vast;
      try {
        vast = await resolveVast(item.vastUrl);
      } catch (e) {
        console.error("VAST resolve failed:", e, item.vastUrl);
        hideOverlay();
        playing = false;
        // Restore live sound if allowed
        if (soundEnabled) player.muted(false);
        return;
      }

      (vast.impressions || []).forEach(fireBeacon);

      // ✅ PLAY AD AUDIO (if user has enabled sound)
      adVideo.playsInline = true;
      adVideo.preload = "auto";
      adVideo.src = vast.mediaUrl;
      adVideo.load();

      // If user hasn't interacted yet, autoplay-with-sound will be blocked.
      adVideo.muted = !soundEnabled;

      const fired = new Set();
      const tick = setInterval(() => {
        remaining -= 1;
        countdownEl.textContent = Math.max(0, remaining);

        const elapsed = total - remaining;
        if (elapsed >= 5) skipBtn.style.display = "inline-block";

        const t = adVideo.currentTime || elapsed;
        const d = (adVideo.duration && isFinite(adVideo.duration)) ? adVideo.duration : total;
        const pct = d > 0 ? (t / d) : 0;

        if (!fired.has("start")) { fired.add("start"); (vast.tracking.start || []).forEach(fireBeacon); }
        if (pct >= 0.25 && !fired.has("firstQuartile")) { fired.add("firstQuartile"); (vast.tracking.firstQuartile || []).forEach(fireBeacon); }
        if (pct >= 0.5 && !fired.has("midpoint")) { fired.add("midpoint"); (vast.tracking.midpoint || []).forEach(fireBeacon); }
        if (pct >= 0.75 && !fired.has("thirdQuartile")) { fired.add("thirdQuartile"); (vast.tracking.thirdQuartile || []).forEach(fireBeacon); }

        if (remaining <= 0) stop("timer");
      }, 1000);

      function stop(reason) {
        clearInterval(tick);
        (vast.tracking.complete || []).forEach(fireBeacon);

        adVideo.pause();
        adVideo.removeAttribute("src");
        adVideo.load();

        hideOverlay();
        playing = false;

        // ✅ RESTORE LIVE AUDIO AFTER AD (only if user enabled sound)
        if (soundEnabled) player.muted(false);
      }

      skipBtn.onclick = () => stop("skip");
      adVideo.onended = () => stop("ended");
      adVideo.onerror = () => {
        console.error("Ad media failed to play:", vast.mediaUrl);
        stop("error");
      };

      try {
        await adVideo.play();
        tapHint.style.display = "none";
      } catch (e) {
        // Autoplay blocked: keep overlay open and ask for tap to enable sound + start playback
        console.warn("Autoplay blocked. Tap to enable sound.", e);
        tapHint.style.display = "block";
        tapHint.onclick = async () => {
          try {
            soundEnabled = true;     // user gesture happened here
            adVideo.muted = false;   // allow ad audio
            await adVideo.play();
            tapHint.style.display = "none";
          } catch (e2) {
            console.warn("Still blocked:", e2);
          }
        };
      }
    }

    /*************************************************
     * SCHEDULER
     *************************************************/
    async function loadSchedule() {
      schedule = await fetch(SCHEDULE_URL, { cache: "no-store" }).then(r => r.json());
    }

    function nowMs() {
      return Date.now() + serverOffsetMs;
    }

    function startLoop() {
      setInterval(() => {
        const t = nowMs();
        const windowMs = 8000;

        schedule.forEach(item => {
          const startMs = item.startUnix * 1000;
          if (t >= startMs && t < startMs + windowMs) {
            playOverlayAd(item);
          }
        });
      }, 500);
    }

    /*************************************************
     * BOOT
     *************************************************/
    (async function init() {
      serverOffsetMs = await getServerOffsetMs();
      await loadSchedule();
      setInterval(loadSchedule, 60_000);
      startLoop();
    })();
  </script>
</body>
</html>
